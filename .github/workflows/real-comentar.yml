name: Real Comentar web.config

on:

  workflow_dispatch: #

jobs:
  modificar-webconfig:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Run script to modify web.config
      run: |
        # Crear un archivo temporal para almacenar el resultado
        tmpfile=$(mktemp)

        # Variable para detectar si estamos dentro de un bloque ya comentado
        inside_comment=0

        # Variable para detectar el bloque que queremos comentar
        block_to_comment=0

        # Procesar el archivo con awk para comentar las líneas necesarias
        awk '
        {
            # Buscar inicio de bloque comentado
            if (/<\!--.*<sessionState/ && !inside_comment) {
                inside_comment = 1
            }
            
            # Buscar fin de bloque comentado
            if (/sessionState>.*-->/ && inside_comment) {
                inside_comment = 0
            }
            
            # Detectar el bloque que queremos comentar
            if (!inside_comment && /<sessionState mode="Custom" customProvider="MySessionStateStore">/) {
                block_to_comment = 1
            }
            
            # Comentar las líneas del bloque que queremos comentar
            if (block_to_comment && /<sessionState mode="Custom" customProvider="MySessionStateStore">/) {
                gsub(/<sessionState mode="Custom" customProvider="MySessionStateStore">/, "<!-- <sessionState mode=\"Custom\" customProvider=\"MySessionStateStore\">")
            }
            
            if (block_to_comment && /<\/sessionState>/) {
                gsub(/<\/sessionState>/, "</sessionState> -->")
                block_to_comment = 0  # Desactivar la bandera después de comentar el bloque
            }
            
            # Imprimir la línea modificada o no modificada
            print $0
        }
        ' web3.config > "$tmpfile"

        # Reemplazar el archivo original con el archivo temporal
        mv "$tmpfile" web3.config
    - name: Upload modified web.config
      uses: actions/upload-artifact@v2
      with:
        name: web3.config
        path: web3.config
